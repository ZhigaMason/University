---
title: "BI-PRS Semestral Project 1"
authors:
  - Oleksandr SLyvka
  - Illia Lyhin
  - Maksym Khavil
output: html_document
date: "2025-03-11"
---

# Semestral Project 1

Our representative is Oleksandr Slyvka, his M-value is 6, that corresponds to Spain, thus we will investigate its data.

## Libraries & Data

The following libraries are used in this R Markdown notebook.

```{R setup, include=FALSE}
library(eurostat)
library(dplyr)
library(vtable)
library(ggplot2)
library(cowplot)
library(e1071)
```

Now we will download dataset, and filter it to contain only information about employment in Spain regions in year 2022.

```{R}
# Raw data
data <- get_eurostat("nama_10r_3empers")
# Selection 2022 only
data <- data[(as.Date('2022-01-01') <= data$TIME_PERIOD) & ( data$TIME_PERIOD < as.Date('2023-01-01')),]
# Number of employed per a thousand citizens
data <- data[(data$wstatus == 'EMP'),]
# NUTS 3 regions in Spain
data <- data[grepl('ES...', data$geo),]
```

We will combine **nace_r2** into four coarser categories *LARGE_BUSINESS*, *SMALL_BUSINESS*, *FINANCE* and *PUBLIC*. Dataset additionally prodvides accumulated *TOTAL* by region, so we will transform it into its own category.

```{R}
data$nace_cat <- "UNKOWN_CATEGORY"
data[grepl("A|B|C|D|E|F", data$nace_r2),]$nace_cat   <- "LARGE_BUSINESS"
data[grepl("G|H|I|J", data$nace_r2),]$nace_cat       <- "SMALL_BUSINESS"
data[grepl("K|L|M|N", data$nace_r2),]$nace_cat       <- "FINANCE"
data[grepl("O|P|Q|R|S|T|U", data$nace_r2),]$nace_cat <- "PUBLIC"
data[grepl("TOTAL", data$nace_r2),]$nace_cat         <- "TOTAL"
head(data)
data
```

We will aggregate all samples based on their **geo** and **nace_cat** feature, because they were split on **nace_r2** subtypes in raw datset.

```{R}
data <- aggregate(values ~ geo + nace_cat, data, sum)
head(data)
```

Our data contains region *ESZZZ* , which is extra region in NUTS 3 and thus contain little statistical significance, but cause some computational problems, so we will remove it here.

```{r}
data <- data[data$geo != 'ESZZZ',]
```

Lastly we will convert **geo** and **nace_cat** into factors and rename **values** to **thousands_employed**.

```{R}
data$geo      <- as.factor(data$geo)
data$nace_cat <- as.factor(data$nace_cat)
colnames(data)[3] <- 'thousands_employed'
head(data)
```

Let's separate unaccumulated NACE categories from *TOTAL*.

```{R}
data.geo.sep <- droplevels(data[data$nace_cat != "TOTAL",])
head(data.geo.sep)
```

```{R}
data.geo.acc <- droplevels(data[data$nace_cat == "TOTAL",])
head(data.geo.acc)
```

## Data Description & Graphs

Let's display the mean, standard deviation, median, interquartile range, and skewness with regard to the *TOTAL*.

```{R warning=FALSE}
summ <- c('mean(x)', 'sd(x)', 'skewness(x)', 'min(x)', 'pctile(x)[25]', 
          'median(x)', 'pctile(x)[75]', 'max(x)', 'IQR(x)'
)

sumtable(
  data.geo.acc, 'thousands_employed',
  out='kable',
  summ=summ
)
```

We can see that data is strongly skewed to the right, that is, there are many samples with smaller than average employed population, also standard deviation and IQR are quite large (593 and 294 thousands people). It is reasonable, as Spain has both city-dense areas as Catalonia and rural regions like Iberian mountains.

We will now dig into NACE category differences.

```{R warning=FALSE}
sumtable(
  data.geo.sep, 'thousands_employed',
  out='kable',
  summ=summ,
  group='nace_cat',  group.long=TRUE
)
```

Visually *SMALL_BUSSINESS*, *LARGE_BUSINESS* and *PUBLIC* categories employ many more people than *FINANCE*, this observation can be tested later. Additionally all categories show very similar skewness, so it could be expected that they match.

Let's Make Q-Q plots to see if those variables are normal.

```{R}
pfin <- ggplot(
        data.geo.sep[data.geo.sep$nace_cat == 'FINANCE',],
        aes(sample=thousands_employed)
    )   +
        stat_qq(distribution=qnorm, show.legend=T) +
        stat_qq_line(distribution=qnorm, show.legend=F) +
        ggtitle("FINANCE")

psmall <- ggplot(
        data.geo.sep[data.geo.sep$nace_cat == 'SMALL_BUSINESS',],
        aes(sample=thousands_employed)
    )   +
        stat_qq(distribution=qnorm, show.legend=T) +
        stat_qq_line(distribution=qnorm, show.legend=F) +
        ggtitle("SMALL_BUSINESS")


ppub <- ggplot(
        data.geo.sep[data.geo.sep$nace_cat == 'PUBLIC',],
        aes(sample=thousands_employed)
    )   +
        stat_qq(distribution=qnorm, show.legend=T) +
        stat_qq_line(distribution=qnorm, show.legend=F) +
        ggtitle("PUBLIC")


plarge <- ggplot(
        data.geo.sep[data.geo.sep$nace_cat == 'LARGE_BUSINESS',],
        aes(sample=thousands_employed)
    )   +
        stat_qq(distribution=qnorm, show.legend=T) +
        stat_qq_line(distribution=qnorm, show.legend=F) +
        ggtitle("LARGE_BUSINESS")

plot_grid(pfin, psmall, ppub, plarge)
```

All Q-Q plots diverge from normal quantile line at the edges and explodes in positive side. We could say that those distributions are not normal, later normality can be tested by numerical methods.

## Contingency table

We will create contingency table over all NUTS 3 regions and all NACE categories.

```{R}
ct <- addmargins(xtabs(formula=thousands_employed ~ geo + nace_cat, data.geo.sep))
print(head(ct, 5))
cat("...\n")
print(tail(ct, 3))
```

Let's test if regions have the same distribution of employment. Pearson's Chi Squared Homogenity Test will assist us in that (the condition of having 5 or more expected counts in 80% of cells in large table is met).

$$
H_0: \text{Employment does not depend on a region}\\
H_A: \text{Employment does depend on a region}
$$

```{R warning=FALSE}
ct_test <- xtabs(formula=thousands_employed ~ geo + nace_cat, data.geo.sep)
print(head(ct_test, 3))
chisq.test(ct_test)
```

p-value is much less than $\alpha = 0.05$, so we reject the null hypothesis in favor of the alternative. Conclusion is that the proportions of people employed in distinct categories are **not the same** for different regions.

<!--# TODO: mosaicplot -->

## Tests

Let's extend our data a little before making hypothesis on it. We can use dataset about population in NUTS 3 regions to make hypotheses testing more meaningful.

```{r}
# population density by NUTS 3 regions
pop_dens_nuts3 <- get_eurostat("demo_r_d3dens")
pop_dens_nuts3 <- pop_dens_nuts3[(as.Date('2022-01-01') <= pop_dens_nuts3$TIME_PERIOD) & ( pop_dens_nuts3$TIME_PERIOD < as.Date('2023-01-01')),]
pop_dens_nuts3 <- pop_dens_nuts3[grepl('ES...', pop_dens_nuts3$geo),]

# area by NUTS 3 regions
area_nuts3 <- get_eurostat("reg_area3")
area_nuts3 <- area_nuts3[(as.Date('2022-01-01') <= area_nuts3$TIME_PERIOD) & ( area_nuts3$TIME_PERIOD < as.Date('2023-01-01')),]
area_nuts3 <- area_nuts3[grepl('ES...', area_nuts3$geo),]
area_nuts3 <- area_nuts3[area_nuts3$landuse == 'TOTAL',]

area <- area_nuts3[, c("geo", "values")]
pop_dens <- pop_dens_nuts3[, c("geo", "values")]

# combining two together
merged_data <- merge(pop_dens, area, by = "geo", suffixes = c("_pop_dens", "_area"))
merged_data$product <- merged_data$values_pop_dens * merged_data$values_area
population <- merged_data[, c("geo", "product")]
colnames(population)[colnames(population) == "product"] <- "pop_in_thousands"
population$pop_in_thousands <- population$pop_in_thousands / 1000

# population by regions in thousands
head(population)
```

### Existence of correlation between employment and population

Let's check hypothesis:

$$
H_0: \text{Correlation between employment and population is 0 }\\
H_A: \text{Correlation is not 0}
$$

First we can combine total employment and population in one table to predict how the test can end.

```{r}
data.corr.test = merge(data.geo.acc, population, by='geo')
head(data.corr.test, 3)
```

It seems like 40% of the population in each region is employed. We can find pearson correlation coefficient to check the linear relation.

```{r}
cor.test(data.corr.test[, 'thousands_employed'], data.corr.test[, 'pop_in_thousands'], method='pearson', alternative = "two.sided")
```

p-value is low, so we reject the null hypothesis. Result of the test indicates almost perfect positive linear relationship and we can predict population from employment and vise versa.

### **Testing if SMALL_BUSINESS** and **LARGE_BUSINESS** come hand-in-hand in all regions

<!--# TODO -->

```         
wilcox.test(paired=True)
utest
```

Let's plot histograms of those variables.

```{R}
data.ct.test = droplevels(data.geo.sep[data.geo.sep$nace_cat %in% c('SMALL_BUSINESS', 'LARGE_BUSINESS'),])


hist(
    data.ct.test[data.ct.test$nace_cat == 'SMALL_BUSINESS',]$thousands_employed,
    freq=FALSE, col=rgb(0.6,0,0, 0.6),
    main = "Histograms", xlab = "Thousands employed", ylab = "Density",
    breaks=15
)

hist(
    data.ct.test[data.ct.test$nace_cat == 'LARGE_BUSINESS',]$thousands_employed,
    freq=FALSE, col=rgb(0,0,0.6, 0.6), add=TRUE,
    breaks=15
)

legend("topright", legend = c("SMALL_BUSINESS", "LARGE_BUSNESS"),
       fill = c(rgb(0.6,0,0, 0.6), rgb(0,0,0.6, 0.6))
       )
```

Distributions look almost the same, so we can say that they are the same.

Let's formulate our hypothesis. For region $Reg_i$, let $X_i$ be a number of employed people in **SMALL_BUSINESS** and $Y_i$ be a number of people employed in **LARGE_BUSINESS**, then our hypotheses are:

$$
H_0: \text{There is no significant association between } X \text{ and } Y\\
H_A: \text{There is a significant association between } X \text{ and } Y
$$

```{r}
small_business <- c(10000, 8000, 12000, 9500, 7800)
large_business <- c(10100, 8005, 12001, 9645, 8009)
wilcox.test(small_business, large_business, paired = TRUE)
```

### *FINANCE* employs less people than the other categories

### withey man u test, variance test. 

```{r}

```

## Conclusion

TBA
